<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8' />
    <link rel="stylesheet" type="text/css" href="../../lib/css/themes/jquery-ui/default/jquery-ui.min.css" />
    <link rel="stylesheet" type="text/css" href="../../lib/css/fancytree/ui.fancytree.min.css" />
    <!--link rel="stylesheet" type="text/css" href="../../lib/css/themes/jquery-ui/redmond/jquery-ui.min.css" /-->
    <!--link rel="stylesheet" type="text/css" href="lib/css/jquery-ui.min.css" />
    <!--link rel="stylesheet" type="text/css" href="../../lib/css/themes/jquery-ui/redmond/jquery-ui.structure.min.css" />
    <link rel="stylesheet" type="text/css" href="../../lib/css/themes/jquery-ui/redmond/jquery-ui.theme.min.css" /-->
    <link rel="stylesheet" type="text/css" href="lib/css/vis.min.css" />

    <script type="text/javascript" src="../../lib/js/jquery-1.11.2.min.js"></script>
    <script type="text/javascript" src="../../lib/js/jquery-ui-1.11.4.full.min.js"></script>
    <!--script type="text/javascript" src="../../lib/js/jquery-1.11.1.min.js"></script>
    <script type="text/javascript" src="../../lib/js/jquery-ui.min.js"></script-->
    <script type="text/javascript" src="../../lib/js/jquery.fancytree-all.min.js"></script>
    <script type="text/javascript" src="../../socket.io/socket.io.js"></script>
    <!--script type="text/javascript" src="lib/js/jquery-ui.min.js"></script-->
    <script type="text/javascript" src="lib/js/vis.min.js"></script>

    <script type="text/javascript" src="../../lib/js/translate.js"></script>
    <script type="text/javascript" src="../../lib/js/selectID.js"></script>
    <script type="text/javascript" src="../../lib/js/loStorage.js"></script>

    <script type="text/javascript" src="lib/js/words.js"></script>

    <style type="text/css">
        body,
        select {
            font: 12pt sans;
        }

        #mynetwork {
            box-sizing: border-box;
            position: relative;
            width: 100%;
            height: 800px;
            border: 2px solid lightgray;
        }

        #config {
            float: left;
            width: 400px;
            height: 600px;
        }

        p {
            font-size: 16px;
            max-width: 700px;
        }

        .clearfix::after {
            visibility: hidden;
            font-size: 0;
            content: " ";
            clear: both;
            height: 0;
            display: table;
        }

        .column15 {
            float: left;
            box-sizing: border-box;
            width: 15%;
            padding: 3px;
        }

        .column25 {
            float: left;
            box-sizing: border-box;
            width: 25%;
            padding: 3px;
        }

        .column33 {
            float: left;
            box-sizing: border-box;
            width: 33%;
            padding: 3px;
        }

        .column45 {
            float: left;
            box-sizing: border-box;
            width: 45%;
            padding: 3px;
        }

        .column50 {
            float: left;
            box-sizing: border-box;
            width: 50%;
            padding: 3px;
        }

        .column40 {
            float: left;
            box-sizing: border-box;
            width: 40%;
            padding: 3px;
        }

        .column60 {
            float: left;
            box-sizing: border-box;
            width: 60%;
            padding: 3px;
        }

        .column80 {
            float: left;
            box-sizing: border-box;
            width: 80%;
            padding: 3px;
        }

        .column20 {
            float: left;
            box-sizing: border-box;
            width: 20%;
            padding: 3px;
        }

        table.legend_table {
            font-size: 11px;
            border-width: 1px;
            border-color: #d3d3d3;
            border-style: solid;
        }

        table.legend_table,
        td {
            border-width: 2px;
            border-color: #d3d3d3;
            border-style: solid;
            padding: 2px;
        }

        div.table_content {
            width: 80px;
            text-align: center;
        }

        div.table_description {
            width: 100px;
        }

        #operation {
            font-size: 28px;
        }

        input.text {
            margin-bottom: 12px;
            width: 95%;
            padding: .4em;
        }

        fieldset {
            padding: 0;
            border: 0;
            margin-top: 25px;
        }

        h1 {
            margin: .6em 0;
        }

        label.text-label {
            line-height: 2;
            vertical-align: middle;
            font-family: Arial, sans-serif;
            font-weight: bold;
            font-size: 0.8em;
            text-align: right;
        }
    </style>

    <script type="text/javascript">
        //            font-weight: bold;
        //                        font: bold 12pt sans;
        //            display: block;
        //            height: 18px;
        //            line-height: 18px;
        //        const socket = io.connect();
        var systemLang = 'en';
        var systemConfig = {};
        var adapterConfig = {};
        var uptimeMap = {};
        var dateOptions = {
            "weekday": "short",
            "year": "numeric",
            "month": "long",
            "day": "2-digit",
            "hour": "2-digit",
            "minute": "2-digit",
            "second": "2-digit"
        };
        var installMsg = {};
        var cmdCallback = null;
        var activeCmdId = null;
        var $stdout = $('#stdout');
        var stdout = '';

        //--------------------------------------------------------- COMMONS -----------------------------------------------------------------------
        /** 
         * Translate word
         * @param {type} word
         * @returns {String}
         */
        function _(word) {
            var text = translateWord(word, systemLang, systemDictionary);

            for (var i = 1; i < arguments.length; i++) {
                var pos = text.indexOf('%s');
                if (pos !== -1) {
                    text = text.replace('%s', arguments[i]);
                }
            }

            return text;
        }
        var nodes = null;
        var edges = null;
        var network = null;
        // randomly create some nodes and edges

        var nodes = [{
                machine: 'test',
                label: 'Aus',
                connections: [
                    "test.Ein"
                ]
            },
            {
                label: '@=1m',
                machine: 'test',
                connections: [
                    "test.Aus"
                ]
            },
            {
                machine: 'test',
                label: 'Ein',
                connections: [
                    "test.Aus"
                ]
            },
            {
                machine: 'test',
                label: 'test',
                connections: [
                    "test.Aus",
                    "test.Ein",
                    "test.@"
                ]
            },
            {
                machine: 'rest',
                label: 'Aus',
                connections: []
            },
            {
                machine: 'rest',
                label: 'rest',
                connections: [
                    "rest.Aus"
                ]
            },
        ];

        // create connections between people
        // value corresponds with the amount of contact between two people
        var data;
        var options = {
            physics: {
                enabled: true,
                stabilization: false,
                barnesHut: {
                    gravitationalConstant: -20000,
                    centralGravity: 2,
                    damping: 0.5,
                    springLength: 225,
                    avoidOverlap: 0.8
                    //                        springLength: 180
                },
            },
            locales: {
                de: {
                    edit: 'Edit',
                    del: 'Lösche Auswahl',
                    back: 'Zurück',
                    addNode: 'State hinzufügen',
                    addEdge: 'Übergang hinzufügen',
                    editNode: 'Edit State',
                    editEdge: 'Edit Übergang',
                    addDescription: 'Auf freien Platz klicken um State zu positionieren!',
                    edgeDescription: 'Klicke auf von-State und ziehe Cursor zu auf-State',
                    editEdgeDescription: 'Click on the control points and drag them to a node to connect to it.',
                    createEdgeError: 'Kann keine Übergänge auf Cluster einfügen!',
                    deleteClusterError: 'Clusters können hier nicht gelöscht werden!',
                    editClusterError: 'Clusters können hier nicht editiert werden!'
                }
            },
            interaction: {
                hover: true,
                navigationButtons: true,
                selectConnectedEdges: false,
                tooltipDelay: 250
            },
            configure: false,
            nodes: {
                borderWidth: 2,
                borderWidthSelected: 10,
                color: createColor(),
                font: {
                    size: 20,
                    face: "verdana",
                    strokeWidth: 2
                },
                scaling: {
                    min: 5,
                    //                    max: null
                },
                shadow: {
                    enabled: true
                },
                shapeProperties: {
                    borderRadius: 10
                },
                size: 20
            },
            edges: {
                arrowStrikethrough: false,
                arrows: {
                    to: {
                        enabled: true,
                    }
                },
                color: {
                    inherit: false
                },
                font: {
                    color: "rgba(15,52,21,1)"
                },
                selfReferenceSize: 35,
                shadow: {
                    enabled: true
                },
                smooth: {
                    forceDirection: "none",
                    roundness: 0.75
                }
            },
            layout: {
                randomSeed: 2
            }, // just to make sure the layout is the same when the locale is changed
            manipulation: {
                enabled: true,
                initiallyActive: true,
                addNode: function (data, callback) {
                    stDialogOpen({
                        machine: curMachine,
                        label: curState
                    }, 'Create State', function (res) {
                        callback(res);
                        if (!res) {
                            network.disableEditMode();
                            network.enableEditMode();
                        } else {
                            $tabStateName.val(curState = res.label);
                            $tabMachineName.val(curMachine = res.machine);
                        }
                    });
                },
                editNode: stEditNode,
                editEdge: stEditEdge,
                deleteNode: stDeleteNode,
                deleteEdge: stDeleteEdge,
                addEdge: saveEdgeData
                /* ,
                               editEdge: {
                                   editWithoutDrag: function (data, callback) {
                                       document.getElementById('edge-operation').innerHTML = "Edit Edge";
                                       editEdgeWithoutDrag(data, callback);
                                   }
                               } */
            }
        };
        var network;
        var container;
        var exportArea;
        var importButton;
        var exportButton;

        function exportNetwork() {
            network.storePositions();
            exportArea.value = "";
            //            var nodes = objectToArray(network.getPositions());
            var nodes = [];
            data.nodes.forEach(function (el) {
                var elem = cloneObject(el);
                delete elem.color;
                delete elem.font;
                delete elem.size;
                delete elem.name;
                delete elem.shape;
                var conns = network.getConnectedNodes(elem.id, 'to');
                var edges = network.getConnectedEdges(elem.id);
                var conns = [];
                edges.forEach(function (eid) {
                    var e = cloneObject(data.edges.get(eid));
                    var f = e.from;
                    delete e.from;
                    delete e.machine;
                    delete e.label;
                    delete e.id;
                    if (f == elem.id) {
                        k = Object.keys(e);
                        if (k.length == 1 && k[0] == 'to')
                            e = e[k];
                        conns.push(e);
                    }
                });
                elem.connections = conns;
                delete elem.id;
                nodes.push(elem);
            });
            exportArea.value = JSON.stringify(nodes, undefined, 2);;
            resizeExportArea();
        }

        function importNetwork() {
            var inputData = JSON.parse(exportArea.value);
            if (Array.isArray(inputData) && inputData.length > 0) {}
            data = createData(inputData);
            draw({
                manipulation: options.manipulation
            });
        }

        function resizeExportArea() {
            //            exportArea.style.height = (1 + exportArea.scrollHeight) + "px";
            exportArea.style.height = exportArea.scrollHeight + "px";
        }

        function destroy() {
            if (network !== null) {
                network.destroy();
                network = null;
            }
        }

        function createColor(background, border, node) {
            node = node || {};
            border = border || (node.color ? node.color.border : false) || 'blue';
            background = background || (node.color ? node.color.background : false) || 'lightblue';
            node.color = {
                border: border,
                background: background,
                highlight: {
                    border: border,
                    background: background
                },
                hover: {
                    border: border,
                    background: background
                }
            };
            return node.color;
        }

        function createData(nodes) {

            function getLabel(node) {
                if (!node)
                    return 'N/A';
                if (node.label && node.label != ' ' && node.machine != node.label)
                    return node.label;
                if (node.machine == node.label)
                    return '*';
                return '!' + node.id;
            }
            const data = {},
                ln = {},
                edges = [],
                nn = [];
            for (let n of nodes) {
                var node = cloneObject(n);
                node.name = node.label.startsWith('@') ? node.label.match(/^(@.?)\=/)[1] : node.label == node.machine ?
                    '*' : node.label;
                node.id = node.machine;
                if (node.machine != node.label)
                    node.id += '.' + node.name;
                ln[node.id] = node;
            }
            for (let k in ln) {
                var n = ln[k];
                if (n && n.connections)
                    for (let c of n.connections) {
                        if (typeof c === 'object') {
                            edges.push(c);
                        } else {
                            const fn = ln[n.id];
                            const cn = ln[c];
                            let l = getLabel(fn) + '>' + getLabel(cn);
                            const edge = {
                                from: n.id,
                                to: cn.id,
                                label: l,
                                id: fn.machine + ':' + l,
                                machine: fn.machine
                            };
                            edges.push(edge);
                        }
                    }
                if (n.machine == n.label) {
                    n.color = createColor('pink');
                    n.shape = 'star';
                    n.name = '*';
                    n.font = {
                        size: 30
                    };
                    n.size = 30;
                } else if (n.label.startsWith('@')) {
                    n.color = createColor('yellow');
                    var m = n.label.match(/^(\@.?)\=/)[1];
                    n.shape = 'box';
                    n.name = "@" + m ? m : '';
                }
                nn.push(n);
            }
            data.nodes = new vis.DataSet(nn);
            data.nodes.on('*', function (event, properties, senderId) {
                addEvent({
                    prop: properties.items[0],
                    node: data.nodes.get(properties.items[0])
                }, 'Node changed');
            });
            data.edges = new vis.DataSet(edges);
            data.edges.on('*', function (event, properties, senderId) {
                addEvent({
                    prop: properties.items[0],
                    edge: data.edges.get(properties.items[0])
                }, 'Edge changed');
            });
            return data;
        }

        var events = [];

        function addEvent(obj, type) {
            if (events.length > 4)
                events.pop();
            events.unshift('<h3>' + type + ' event:' + new Date().toISOString() + '</h3>' + JSON.stringify(obj, null, 4));
            var s = '';
            events.forEach(function (x) {
                s += x;
            });
            document.getElementById('eventSpan').innerHTML = s;
        }

        function draw(opt) {
            destroy();
            network = new vis.Network(container, data, opt || options);
            network.on("configChange", function () {
                // this will immediately fix the height of the configuration
                // wrapper to prevent unecessary scrolls in chrome.
                // see https://github.com/almende/vis/issues/1568
                var div = container.getElementsByClassName('vis-configuration-wrapper')[0];
                div.style["height"] = div.getBoundingClientRect().height + "px";
            });
            //            network.on("selectNode", function (params) {
            //                changeOnSelect(params, "Node");
            //            });
            network.on('zoom', function (params) {
                addEvent({
                    scale: params.scale
                }, 'Zoom ' + params.direction);
            });

            network.once('stabilized', function () {
                network.setOptions({
                    physics: {
                        stabilization: {
                            fit: false
                        }
                    }
                });
                network.stabilize();
            });
            clusterPositions = {};
            network.on("click", function (params) {
                var m = {
                    manipulation: {
                        enabled: true
                    }
                };
                if (params.nodes.length == 1 && params.nodes[0].startsWith('cluster:')) {
                    addEvent(getParams(params), "Select Cluster");
                    m.manipulation.enabled = false;
                } 
                network.setOptions(m);
            });
            network.on("doubleClick", function (params) {
                addEvent(getParams(params), "DoubleClick");
                if (params.nodes.length == 1) {
                    var nid = params.nodes[0];
                    if (network.isCluster(nid)) {
                        network.openCluster(nid, {
                            releaseFunction: function (clusterPosition, containedNodesPositions) {
                                var newPositions = {};
                                // clusterPosition = {x:clusterX, y:clusterY};
                                // containedNodesPositions = {nodeId:{x:nodeX,y:nodeY}, nodeId2....}
                                for (nodeId in containedNodesPositions)
                                    newPositions[nodeId] = {
                                        x: containedNodesPositions[nodeId].x,
                                        y: containedNodesPositions[nodeId].y
                                    };
                                return newPositions;
                            }
                        });
                        var m = nid.split(':')[1];
                        data.edges.forEach(function (edge) {
                            data.edges.update(edge);
                        }, {
                            filter: function (item) {
                                return item.machine == m;
                            }
                        });
                        return;
                    }
                    var machine = data.nodes.get(nid);
                    if (!machine) return;
                    machine = machine.machine;
                    //                  mass = 0;
                    clusterOptionsByData = {
                        joinCondition: function (childOptions) {
                            return childOptions.machine == machine;
                        },
                        /*                        
                                                processProperties: function (clusterOptions, childNodes, childEdges) {
                                                    var totalMass = 0;
                                                    for (var i = 0; i < childNodes.length; i++) {
                                                        totalMass += childNodes[i].mass;
                                                    }
                                                    clusterOptions.mass = totalMass;
                                                    return clusterOptions;
                                                },
                        */
                        clusterNodeProperties: {
                            id: 'cluster:' + machine,
                            borderWidth: 3,
                            shape: 'database',
                            color: 'lightgreen',
                            label: machine,
                            //                            mass: 1,
                            font: {
                                size: 30
                            }
                        }
                    };
                    network.storePositions();
                    network.cluster(clusterOptionsByData);
                }
            });

            network.on("selectEdge", function (params) {
                //               if (params.nodes.length==0)
                params = getParams(params);
                var edge = params[params.eid];
                var isstar = edge.from == edge.machine;
                network.setOptions({
                    manipulation: {
                        editEdge: isstar ? false : stEditEdge
                    }
                });
                network.setOptions({
                    manipulation: {
                        deleteEdge: isstar ? false : stDeleteEdge
                    }
                });

                addEvent(params, "Select Edge");
            });
            network.on("selectNode", function (params) {
                //               if (params.nodes.length==0)
                params = getParams(params);
                if (params.nid) {
                    var node = params[params.nid];
                    if (node) {
                        curMachine = node.machine;
                        $tabMachineName.val(curMachine).show();
                        if (node.label != node.machine) {
                            curState = node.label
                            $tabStateName.val(curState).prop('disabled', false).show();
                        } else $tabStateName.val(curState).prop('disabled', true).show();
                    }
                } else
                    $tabStateName.hide();
                var isstar = params.nid == params[params.nid].machine;
                var machs = getMachineStates(params[params.nid].machine);
                network.setOptions({
                    manipulation: {
                        editNode: isstar ? false : stEditNode
                    }
                });
                network.setOptions({
                    manipulation: {
                        deleteNode: isstar || machs.length <= 2 ? false : stDeleteNode
                    }
                });
                addEvent(params, "Select Node");
            });
            exportArea.value = "";
            resizeExportArea();
        }

        function cloneObject(obj) {
            return JSON.parse(JSON.stringify(obj));
        }

        function getParams(par) {
            var params = cloneObject(par);
            var n = params.nodes;
            var e = [];
            delete params.pointer;
            delete params.event;
            params.edges.forEach(function (edge) {
                e.push(data.edges.get(edge))
            });
            if (n.length === 0 && e.length == 1) {
                params.eid = params.edges[0];
                params[params.eid] = e[0];
            } else
                params.edges = e;

            var nid = n.length == 1 && n[0];
            if (nid) {
                params.nid = nid;
                var node = data.nodes.get(nid);
                if (node) {
                    var cn = cloneObject(node);
                    delete cn.color;
                    delete cn.font;
                    params[nid] = cn;
                } else if (network.isCluster(nid))
                    params[nid] = network.getNodesInCluster(nid);
            }
            if (typeof params.to === 'object')
                params.to = params.to.id
            if (typeof params.from === 'object')
                params.from = params.from.id
            return params;
        }

        function getMachineStates(machine) {
            return data.nodes.get({
                filter: function (item) {
                    return (item.machine == machine);
                }
            });
        }

        function checkStarState(state) {
            var pos = network.getPositions();
            if (state && state.id) {
                var nst = JSON.parse(JSON.stringify(state));
                var p = pos[nst.id];
                if (p) {
                    nst.x = p.x;
                    nst.y = p.y;
                }
                if (!data.nodes.get(nst.machine)) {
                    nst.size = 30;
                    nst.shape = 'star';
                    nst.name = '*';
                    nst.font = {
                        size: 30
                    };
                    nst.color = createColor('pink');
                    nst.label = nst.machine;
                    nst.id = nst.machine;
                    data.nodes.add(nst);
                } else
                    nst = data.nodes.get(nst.machine);

                var conn = network.getConnectedNodes(nst.id, 'to');
                if (conn.indexOf(state.id) < 0) {
                    var edge = {
                        to: state.id,
                        from: nst.id,
                        machine: nst.machine,
                        label: nst.name + '>' + state.name
                    };
                    edge.id = edge.machine + ':' + edge.label;
                    data.edges.add(edge);
                }
            }

        }

        function stEditEdge(edge, callback) {
            if (typeof edge.from === 'object')
                edge.from = edge.from.id
            if (typeof edge.to === 'object')
                edge.to = edge.to.id
        }

        function stDeleteEdge(edge, callback) {
            if (typeof edge.from === 'object')
                edge.from = edge.from.id
            if (typeof edge.to === 'object')
                edge.to = edge.to.id
        }

        function saveEdgeData(edge, callback) {
            if (edge.from == edge.to) {
                var r = confirm("Do you want to connect the node to itself?");
                if (r != true)
                    return callback(null);
            }

            if (typeof edge.to === 'object')
                edge.to = edge.to.id
            if (typeof edge.from === 'object')
                edge.from = edge.from.id
            var nf = data.nodes.get(edge.from);
            var nt = data.nodes.get(edge.to);

            if (nf.machine != nt.machine)
                return main.showError(
                    `cannot connect states from different machines! "${nf.machine}" and "${nt.machine}"`, callback);

            if (nt.label == nt.machine || nf.label == nf.machine) // this are '*' states!
                return main.showError(`cannot connect states to Machines ('Stars'/*)!`, callback);

            if (nf.name.startsWith('@') && network.getConnectedNodes(nf.id, 'to').length > 0)
                return main.showError(`cannot connect more than ONE state to timer-states like "${nf.id}"!`, callback);

            if (network.getConnectedNodes(nf.id, 'to').indexOf(nt.id) >= 0)
                return main.showError(`cannot connect more than ONE time to the SAME state:"${nf.id}" > "${nt.id}"!`,
                    callback);

            edge.machine = nf.machine;
            edge.label = nf.name + '>' + nt.name;
            edge.id = edge.machine + ':' + edge.label;
            //            clearEdgePopUp();
            callback(edge);
        }

        function changeOptions() {
            //            var div = container.getElementsByClassName('vis-configuration-wrapper')[0];
            options.configure = !options.configure;
            network.setOptions({
                configure: options.configure
            });
            //            div.style["height"] = options.configure ? div.getBoundingClientRect().height + "px" : '1px';            
            //            draw();
        }

        var stDialog;


        function stDeleteNode(params, callback) {
            var node = data.nodes.get(params.nodes[0]);
            if (!node)
                return;
            if (node.name == '*')
                return main.showError("Cannot delete '*'- (Machine-) States,\nyou need to delete machine!", callback);
            else if (getMachineStates(node.machine).length <= 2)
                return main.showError("Cannot delete last state from lachine,\nyou need to delete machhine!", callback);

            //            stDialogOpen(params, 'Delete State', callback);
            main.confirmMessage(`Do you really want to delete ${node.label}`, 'Delete Nopde', 'help', function (ok) {
                callback(ok ? params : null);
            });
        }

        function stEditNode(params, callback) {
            if (params.name == '*')
                return main.showError("Cannot edit '*'- (Machine-) States!", callback);
            var n = cloneObject(params);
            n.name = n.label;
            stDialogOpen(n, 'Edit/Rename State', callback);
        }

        function stDialogOpen(item, action, callback) {
            //            var $dialog = $("#state-dialog-form"); 
            stDialog.find('.state-dialog-field').removeClass("ui-state-error");
            stDialog._$machine = stDialog.find('#machine');
            stDialog._$tips = stDialog.find(".validateTips");
            stDialog._$name = stDialog.find('#name');
            stDialog._$item = item;
            stDialog._$create = action.startsWith('Create ');
            stDialog._$callback = callback;
            if (item && item.machine) {
                stDialog._$machine.val(item.machine);
            }
            if (item && item.name) {
                stDialog._$name.val(item.name);
            } else if (!stDialog._$create && item.label)
                stDialog._$name.val(item.label);

            stDialog._$machine.prop('disabled', !stDialog._$create);

            stDialog._$tips.text("All form fields are required");
            stDialog.dialog('option', 'title', action);
            stDialog.dialog("open");
        }

        function addState() {
            function verify(item, text, regexp, max) {
                var v = item.val();
                var r = typeof regexp === 'number' ? v.length >= regexp && (typeof max === 'number' ? v.length <= max :
                    true) : regexp.test(v);
                if (r)
                    return true;
                item.addClass("ui-state-error");
                stDialog._$tips.text(text);
            }

            var ok = true;
            ok = ok && verify(stDialog._$machine, "Länge muss zwischen 3 und 20 sein", 3, 20);
            ok = ok && verify(stDialog._$machine, "Text darf nur '$_A-Za-z0-9' enthalten", /^\s*[$\w]+\s*$/);
            ok = ok && verify(stDialog._$name, "Länge muss zwischen 3 und 20 sein", 3, 20);
            ok = ok && verify(stDialog._$name, "Text darf nur '$_A-Za-z0-9' enthalten oder @(x)=(*h)(*m)(*s)",
                /^\s*([$\w]+|@(.?)\s*=\s*(.+?))\s*$/);
            if (ok) {
                var m = stDialog._$machine.val().trim();
                var l = stDialog._$name.val().trim();
                var match = l.match(/^@(.?)\s*=\s*(.+)$/);
                var node = stDialog._$item;
                node.machine = m;
                if (match) {
                    node.shape = 'box';
                    node.timeout = match[2];
                    node.name = node.id = '@' + match[1];
                    node.label = l;
                    node.id = node.machine + '.' + node.name;
                    node.color = createColor('yellow');
                } else {
                    //                node.id = node.label.trim();
                    node.label = l;
                    node.name = l;
                    node.id = node.machine + '.' + node.name;
                }
                if (data.nodes.get(node.id))
                    return main.showError(`A state with this name exist already and cannot be added multiple times!`);
                stDialog._$tips.text("All form fields are required");
                stDialog.find('.state-dialog-field').removeClass("ui-state-error");
                stDialog._$item.name = l;
                stDialog._$item = node;
                stDialog._$item.machine = m;
                if (stDialog._$callback) {
                    stDialog._$callback(node);
                    stDialog._$callback = null;
                }
                stDialog.dialog("close");
                setTimeout(checkStarState, 100, node);
            }
            return ok;
        }

        var dialogMessage, $dialogConfirm, firstConnect = true,
            that = this;

        var main = {
            objects: {},
            states: {},
            mstate: {},
            sstate: {},
            currentId: null,
            currentHost: '',
            hosts: [],
            instances: [],
            that: this,
            changed: false,
            objectsLoaded: false,
            waitForRestart: false,
            selectId: null,
            connectCb: null,
            socket: io.connect(),

            //            socket: io.connect(location.protocol + '//' + location.host, {
            //                query: 'ws=true'
            //            }),
            saveConfig: function (attr, value) {
                if (!main.config) return;
                if (attr) main.config[attr] = value;

                if (typeof storage !== 'undefined') {
                    storage.set('adminConfig', JSON.stringify(main.config));
                }
            },
            showError: function (error, cb) {
                main.showMessage(_(error), _('Error'), 'alert', cb);
            },
            showMessage: function (message, title, icon, cb) {
                if (typeof title === 'function') {
                    cb = title;
                    title = null;
                    icon = null;
                }
                if (typeof icon === 'function') {
                    cb = icon;
                    icon = null;
                }
                $dialogMessage.dialog('option', 'title', title || _('Message'));
                $('#dialog-message-text').html(message);

                if (icon) {
                    if (!icon.match(/^ui\-icon\-/)) icon = 'ui-icon-' + icon;

                    $('#dialog-message-icon').show();
                    $('#dialog-message-icon').attr('class', '');
                    $('#dialog-message-icon').addClass('ui-icon ' + icon);
                } else {
                    $('#dialog-message-icon').hide();
                }
                $dialogMessage.data('callback', cb);
                $dialogMessage.dialog('open');
            },
            confirmMessage: function (message, title, icon, buttons, callback) {
                if (typeof buttons === 'function') {
                    callback = buttons;
                    $dialogConfirm.dialog('option', 'buttons', [{
                            text: _('Ok'),
                            click: function () {
                                var cb = $(this).data('callback');
                                $(this).dialog('close');
                                if (cb) cb(true);
                            }
                        },
                        {
                            text: _('Cancel'),
                            click: function () {
                                var cb = $(this).data('callback');
                                $(this).dialog('close');
                                if (cb) cb(false);
                            }
                        }

                    ]);
                } else if (typeof buttons === 'object') {
                    for (var b = 0; b < buttons.length; b++) {
                        buttons[b] = {
                            text: buttons[b],
                            id: 'dialog-confirm-button-' + b,
                            click: function (e) {
                                var id = parseInt(e.currentTarget.id.substring('dialog-confirm-button-'
                                    .length), 10);
                                var cb = $(this).data('callback');
                                $(this).dialog('close');
                                if (cb) cb(id);
                            }
                        }
                    }
                    $dialogConfirm.dialog('option', 'buttons', buttons);
                }

                $dialogConfirm.dialog('option', 'title', title || _('Message'));
                $('#dialog-confirm-text').html(message);
                if (icon) {
                    $('#dialog-confirm-icon').show();
                    $('#dialog-confirm-icon').attr('class', '');
                    $('#dialog-confirm-icon').addClass('ui-icon ui-icon-' + icon);
                } else {
                    $('#dialog-confirm-icon').hide();
                }
                $dialogConfirm.data('callback', callback);
                $dialogConfirm.dialog('open');
            },
            initSelectId: function () {
                if (main.selectId) return main.selectId;
                main.selectId = $('#dialog-select-member').selectId('init', {
                    objects: main.objects,
                    states: main.states,
                    noMultiselect: true,
                    imgPath: '../../lib/css/fancytree/',
                    filter: {
                        type: 'state'
                    },
                    texts: {
                        select: _('Select'),
                        cancel: _('Cancel'),
                        all: _('All'),
                        id: _('ID'),
                        name: _('Name'),
                        role: _('Role'),
                        room: _('Room'),
                        value: _('Value'),
                        selectid: _('Select ID'),
                        from: _('From'),
                        lc: _('Last changed'),
                        ts: _('Time stamp'),
                        wait: _('Processing...'),
                        ack: _('Acknowledged')
                    },
                    columns: ['image', 'name', 'role', 'room', 'value']
                });
                return main.selectId;
            },
            addSState: function addSState(obj, id) {
                if (obj.type === 'state') {
                    var n = obj.common.name;
                    if (!main.mstate[n]) {
                        if (main.sstate[n]) {
                            main.mstate[n] = [id];
                            delete main.sstate[n];
                        } else
                            main.sstate[n] = id;
                    } else main.mstate[n].push(id);
                }

            },
            objectChange: function (id, obj) {
                if (obj) {
                    if (obj._rev && main.objects[id]) main.objects[id]._rev = obj._rev;
                    if (!main.objects[id] || JSON.stringify(main.objects[id]) != JSON.stringify(obj)) {
                        main.objects[id] = obj;
                    }
                } else if (main.objects[id]) {
                    var oldObj = {
                        _id: id,
                        type: main.objects[id].type
                    };
                    delete main.objects[id];
                    if (oldObj.type === 'instance') {
                        var pos = main.instances.indexOf(id);
                        if (pos !== -1) main.instances.splice(pos, 1);
                    } else if (oldObj.type === 'script') {
                        var pos = main.instances.indexOf(id);
                        if (pos !== -1) main.instances.splice(pos, 1);
                    } else if (id.match(/^script\.js\./) && oldObj.type === 'channel') {
                        var pos = main.instances.indexOf(id);
                        if (pos !== -1) main.instances.splice(pos, 1);
                    }
                }

                if (main.selectId) main.selectId.selectId('object', id, obj);

                if (id.match(/^system\.adapter\.[-\w]+\.[0-9]+$/)) { /// TODO
                    // Disable statemachine tab if no one script engine instance found
                    var engines = main.fillEngines();
                    $('#tabs').tabs('option', 'disabled', (engines && engines.length) ? [] : [4]);
                }

                addEvent(obj, `Object Change of ${id}`);
            },
            stateChange: function (id, state) {
                var s = {
                    ostate: main.states[id] || {},
                    nstate: cloneObject(state),
                };
                for (var k of Object.keys(state))
                    if (s.ostate[k] == s.nstate[k])
                        delete s.nstate[k];
                state.lc = s.nstate.lc = s.ostate.ts;
                if (!id.match(/^system\./)) {
                    addEvent(s, `State change of ${id}`);
                    /// TODO: check machine states to display them!
                }
                //id = id ? id.replace(/[\s'"]/g, '_') : ''; /// TODO - do not know what it does!
                //if (!id || !id.match(/\.messagebox$/)) {
                //    if (main.selectId) main.selectId.selectId('state', id, state);
                //}
                main.states[id] = state;
            },
            getStates: function (callback) {
                main.socket.emit('getStates', function (err, res) {
                    main.states = res;
                    if (typeof callback === 'function')
                        setTimeout(callback, 0);
                });
            },
            getObjects: function (callback) {
                main.socket.emit('getAllObjects', function (err, res) {
                    setTimeout(function () {
                        var obj;
                        main.objects = res;
                        for (var id in main.objects) {
                            if (id.slice(0, 7) === '_design') continue;

                            obj = res[id];
                            main.addSState(obj, id);
                            if (obj.type === 'instance') main.instances.push(id);
                            //                        if (obj.type === 'channel' && id.match(/^script\.js\./)) main.groups.push(id);
                            if (obj.type === 'host') main.hosts.push(id);
                        }
                        main.objectsLoaded = true;

                        //                    main.prepare();
                        //                    main.init();

                        if (typeof callback === 'function') callback();
                    }, 0);
                });
            },
            /** 
             * Read the settings for adapter
             * @param {type} callback
             */
            readInstanceConfig: function (callback) {
                systemConfig = main.objects['system.config'];
                addEvent(systemConfig, "System Config");
                if (systemConfig && systemConfig.common) {
                    systemLang = systemConfig.common.language;
                } else {
                    systemLang = window.navigator.userLanguage || window.navigator.language;

                    if (systemLang !== 'en' && systemLang !== 'de' && systemLang !== 'ru') {
                        systemConfig.common.language = 'en';
                        systemLang = 'en';
                    }
                }
                adapterConfig = main.objects['system.adapter.statemachine.0'];
                if (adapterConfig && adapterConfig.native)
                    adapterConfig = adapterConfig.native;
                else
                    adapterConfig = null;
                addEvent({
                    adapterConfig: adapterConfig,
                    language: systemLang,
                    states: Object.keys(main.states).length,
                    objects: Object.keys(main.objects).length,
                    hosts: Object.keys(main.hosts).length,
                }, "Adapter Config")
                if (typeof callback === 'function') {
                    callback();
                }
            },
            init: function (callb) {
                if (callb)
                    main.connectCb = callb;
                main.socket.on('permissionError', function (err) {
                    main.showMessage(_('Has no permission to %s %s %s', err.operation, err.type, (err.id ||
                        '')));
                });
                main.socket.on('objectChange', function (id, obj) {
                    setTimeout(main.objectChange, 0, id, obj);
                });
                main.socket.on('onUpdate', function (id, obj) {
                    setTimeout(main.stateChange, 0, id, obj);
                });
                main.socket.on('stateChange', function (id, obj) {
                    setTimeout(main.stateChange, 0, id, obj);
                });
                main.socket.on('connect', function () {
                    $('#connecting').hide();
                    if (firstConnect) {
                        firstConnect = false;

                        main.socket.emit('getUserPermissions', function (err, acl) {
                            main.acl = acl;
                            // Read system configuration
                            main.socket.emit('getObject', 'system.config', function (err, data) {
                                main.systemConfig = data;
                                if (!err && main.systemConfig && main.systemConfig.common) {
                                    systemLang = main.systemConfig.common.language;
                                } else {
                                    systemLang = window.navigator.userLanguage ||
                                        window.navigator.language;

                                    if (systemLang !== 'en' && systemLang !== 'de' &&
                                        systemLang !==
                                        'ru') {
                                        main.systemConfig.common.language = 'en';
                                        systemLang = 'en';
                                    }
                                }

                                translateAll();

                                $dialogMessage.dialog({
                                    autoOpen: false,
                                    modal: true,
                                    width: "30%",
                                    maxWidth: "500px",
                                    buttons: [{
                                        text: _('Ok'),
                                        click: function () {
                                            $(this).dialog('close');
                                            var cb = $(this).data(
                                                'callback');
                                            if (typeof cb ===
                                                'function') {
                                                $(this).data(
                                                    'callback',
                                                    null);
                                                cb();
                                            }
                                        }
                                    }]
                                });

                                $dialogConfirm.dialog({
                                    autoOpen: false,
                                    modal: true,
                                    width: "30%",
                                    maxWidth: "500px",
                                    //                                    width: 400,
                                    height: 200,
                                    buttons: [{
                                            text: _('Ok'),
                                            click: function () {
                                                var cb = $(this).data(
                                                    'callback');
                                                $(this).dialog('close');
                                                if (cb) cb(true);
                                            }
                                        },
                                        {
                                            text: _('Cancel'),
                                            click: function () {
                                                var cb = $(this).data(
                                                    'callback');
                                                $(this).dialog('close');
                                                if (cb) cb(false);
                                            }
                                        }

                                    ]
                                });

                                main.getStates(function () {
                                    main.getObjects(function () {
                                        main.readInstanceConfig(
                                            function () {
                                                if (main.connectCb)
                                                    main.connectCb();
                                            })
                                    })
                                });
                            });
                        });
                    }
                    if (main.waitForRestart) {
                        location.reload();
                    }
                });
                main.socket.on('disconnect', function () {
                    $('#connecting').show();
                });
                main.socket.on('reconnect', function () {
                    $('#connecting').hide();
                    if (main.waitForRestart) {
                        location.reload();
                    }
                });
                main.socket.on('reauthenticate', function () {
                    location.reload();
                });
                main.socket.on('log', function (message) {
                    setTimeout(main.onLog, 0, message);
                });

            }
        };

        main.init(function () {
            options.locale = systemLang;
            data = createData(nodes);
            draw();
        });

        window.onbeforeunload = function (evt) {
            if (main.changed) {
                if (window.confirm(_('Script changes are not saved. Discard?'))) {
                    return null;
                } else {
                    return _('Configuration not saved.');
                }
            }
            return null;
        };

        var $tabMachineName, $tabStateName, curMachine, curState, curEdge, curVar, curEvent;
        $(function () {
            container = document.getElementById('mynetwork');
            exportArea = document.getElementById('input_output');
            importButton = document.getElementById('import_button');
            exportButton = document.getElementById('export_button');
            $dialogMessage = $('#dialog-message');
            $dialogConfirm = $('#dialog-confirm');

            $('#dialog-edit-insert-id').button({
                icons: {
                    primary: 'ui-icon-note'
                }
            }).css('height', '30px').click(function () {
                var ids = [];
                //                $(":focus").each(function () {
                //                    ids.push($(this).attr("id") + " has focus!");
                //                });
                addEvent(ids, " Focus");
                var sid = main.initSelectId();
                sid.selectId('show', function (newId) {
                    main.showMessage(newId);
                    //                    that.editorDialog.insert('"' + newId + '"' + ((that.main.objects[newId] && that.main.objects[newId].common && that.main.objects[newId].common.name) ? ('/*' + that.main.objects[newId].common.name + '*/') : ''));
                    //                    that.editorDialog.focus();
                });
            });

            // Read all positions, selected widgets for every view,
            // Selected view, selected menu page,
            // Selected widget or view page
            // Selected filter
            if (typeof storage !== 'undefined') {
                try {
                    main.config = storage.get('adminConfig');
                    if (main.config) {
                        main.config = JSON.parse(main.config);
                    } else {
                        main.config = {};
                    }
                } catch (e) {
                    console.log('Cannot load edit config');
                    main.config = {};
                }
            } //            alert('Selection length:' + $("#node-popUp").length + ', ' + $("#nodepopUp").length+ ', ' + $("#nodePopUp").length)
            $tabMachineName = $('#tab-machine-name').prop('disabled', true).change(function () {
                curMachine = $(this).val();
            });
            $tabStateName = $('#tab-state-name').prop('disabled', true).change(function () {
                curState = $(this).val();
            });
            $('#tab-physics').prop('checked', options.physics.enabled).change(function () {
                options.physics.enabled = this.checked;
                network.setOptions({
                    physics: {
                        enabled: options.physics.enabled
                    }
                });
                if (this.checked)
                    network.startSimulation();
                else network.stopSimulation();
            });
            //                        $(".st-control").controlgroup({
            //                            "direction": "vertical"
            //                        });
            stDialog = $("#state-dialog-form").dialog({
                autoOpen: false,
                //                dialogClass: "no-close",
                height: 300,
                width: 500,
                modal: true,
                buttons: [{
                        text: 'Save State',
                        click: addState
                    },
                    {
                        text: 'Cancel',
                        click: function (event) {
                            $(this).dialog('close');
                        }
                    }
                ],
                close: function () {
                    form[0].reset();
                    if (stDialog._$callback)
                        stDialog._$callback(null);
                    stDialog._$callback = null;
                }
            });

            form = stDialog.find("form").on("submit", function (event) {
                event.preventDefault();
                addState();
            });
            $('.myButtons').button({
                icon: "ui-icon-star"
            });
            $('#create-state').button({
                icon: "ui-icon-star"
            });
            $('#importButton').click(function (event) {
                importNetwork();
            });
            $('#exportButton').click(function (event) {
                exportNetwork();
            });
            $('#destroyButton').click(function (event) {
                destroy();
            });
            $('#endcreate').click(function (event) {
                network.disableEditMode();
                network.enableEditMode();
            });
            $('#create-state').click(function (event) {
                network.addNodeMode();
            });
            $('#createStateButton').click(function (event) {
                stDialogOpen({
                    machine: $tabMachineName.val(),
                    name: 'newName'
                }, "Create State", null);
            });
            $('#changeOptions').click(function (event) {
                options.configure = !options.configure;
                $(this).text(options.configure ? "Hide Options" : "Show Options");
                network.setOptions({
                    configure: options.configure
                });
            });
            //            init();
        });
    </script>
</head>

<body>
    <div id="homeTemplate">


        <div class="page-title">
            <div class="column50">
                <a href="../../lib/css/themes/jquery-ui/redmond/jquery-ui.min.css">../../lib/css/themes/jquery-ui/redmond/jquery-ui.min.css</a>
                <link rel="stylesheet" type="text/css" href="../../lib/css/themes/jquery-ui/redmond/jquery-ui.structure.min.css" />
                <link rel="stylesheet" type="text/css" href="../../lib/css/themes/jquery-ui/redmond/jquery-ui.theme.min.css" />
                <a href="lib/css/vis.min.css">lib/css/vis.min.css</a>
                <h1>StateMachine Adapter Config</h1>
            </div>
            <div class="column25">
                <h3>import/export</h3>
            </div>
            <div class="column25">
                <h3>Options</h3>
            </div>
        </div>
        <div class="clearfix"></div>

        <div id="home-container">
            <div class="column50">
                <div id="mynetwork"></div>
            </div>

            <div class="column25 st-control">
                <button id="changeOptions" class="myButtons">Show Options</button>
                <button id="importButton" class="myButtons">import</button>
                <button id="exportButton" class="myButtons">export</button>
                <button id="destroyButton" class="myButtons">destroy</button>
                <br>
                <button id="createStateButton" class="myButtons">CreateState</button>
                <button id="create-state" class="myButtons">create-state</button>
                <div class="clearfix"></div>
                <button id="endcreate" class="myButtons">EndCreate</button>
                <div class="clearfix"></div>
                <label class="column25 text-label" for="machineName">Machine Name</label>
                <span class="column50">
                    <input type="text" name="machineName" id="tab-machine-name" value="newMachine" class="text ui-widget-content ui-corner-all">
                </span>
                <div class="clearfix"></div>
                <label class="column25 text-label" for="stateName">State Name</label>
                <span class="column50">
                    <input type="text" name="stateName" id="tab-state-name" value="newState" class="text ui-widget-content ui-corner-all">
                </span>
                <div class="clearfix"></div>
                <label class="column25 text-label" for="stphysics">Physics enabled</label>
                <span class="column50">
                    <input type="checkbox" name="stphysics" id="tab-physics">
                </span>
                <div class="clearfix"></div>
                <button id="dialog-edit-insert-id" class="translate">Insert ID</button>
                <br>
                <textarea cols="40" rows="50" id=input_output></textarea>
            </div>
            <div class="column25">
                <pre id="eventSpan" style="font-size: 0.8em"></pre>
            </div>
            <div class="clearfix"></div>

        </div>
        <div class="tile-stats">
        </div>
        <div id="dialog-select-member" style="display:none"></div>
        <div id="dialog-message" title="Message" style="display: none">
            <p>
                <span id="dialog-message-icon" class="ui-icon ui-icon-circle-check" style="float: left; margin: 0 7px 50px 0;"></span>
                <span id="dialog-message-text"></span>
            </p>
        </div>
        <div id="dialog-confirm" title="Question" style="display: none">
            <p>
                <span id="dialog-confirm-icon" class="ui-icon ui-icon-circle-check" style="float: left; margin: 0 7px 50px 0;"></span>
                <span id="dialog-confirm-text" width="500px"></span>
            </p>
        </div>
        <div id="state-dialog-form" title="...State">
            <p class="validateTips">All form fields are required.</p>
            <form>
                <fieldset>
                    <label class="column40 ui-font" for="machine">Machine Name</label>
                    <input class="column60" type="text" name="machine" id="machine" value="thisMachine" class="text ui-widget-content ui-corner-all state-dialog-field">
                    <div class="clearfix"></div>
                    <label class="column40 ui-font" for="name">State Name</label>
                    <input class="column60" type="text" name="name" id="name" value="newState" class="text ui-widget-content ui-corner-all state-dialog-field">
                    <!-- Allow form submission with keyboard without duplicating the dialog button -->
                    <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
                </fieldset>
            </form>
        </div>

    </div>

    </div>

</body>

</html>